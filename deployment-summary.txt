DEPLOYMENT SUMMARY: Open WebUI KidsGPT on Heroku
==================================================
Last Updated: 2026-02-05

PROJECT OVERVIEW
----------------
- Application: Open WebUI KidsGPT (modified version of Open WebUI)
- Deployment Platform: Heroku
- Database: Heroku Postgres (essential-0 tier)
- Two deployment methods supported: Container (Docker) and Buildpack

DEPLOYMENT OPTIONS
------------------
1. CONTAINER STACK (Docker) - Recommended
   - heroku stack:set container
   - Uses Dockerfile (multi-stage: Node frontend + Python backend)
   - Frontend built in Docker; no buildpack ordering issues
   - App: contextquiz-openwebui-kidsgpt

2. BUILDPACK STACK (heroku-22/24)
   - Node.js buildpack MUST be first (builds frontend)
   - Then heroku/python
   - heroku buildpacks:add --index 1 heroku/nodejs
   - App: dsl-kidsgpt-pilot

KEY CONFIGURATION FILES
-----------------------
1. Procfile:
   release: cd backend/open_webui && python -m alembic upgrade head
   web: cd backend && uvicorn open_webui.main:app --host 0.0.0.0 --port $PORT

2. heroku.yml: Docker build/run config (for container stack)

3. app.json: Buildpack order (nodejs, python) for new apps

4. .slugignore: Excludes data, notebooks, Docker files, etc. from buildpack slug

5. requirements.txt (root): Slimmed for Heroku; optional packages removed/lazy

OPTIONAL PACKAGES (Lazy Imports - Install If Needed)
----------------------------------------------------
Removed from requirements.txt to reduce slug size and memory:
- boto3 (STORAGE_PROVIDER=s3)
- google-cloud-storage (STORAGE_PROVIDER=gcs)
- azure-identity, azure-storage-blob (STORAGE_PROVIDER=azure)
- azure-ai-documentintelligence (document_intelligence loader)
- ddgs (DuckDuckGo search)
- firecrawl-py (WEB_LOADER_ENGINE=firecrawl)
- tencentcloud-sdk-python (Sogou search)
- opentelemetry-* (ENABLE_OTEL=true)

Code uses lazy imports; clear errors when feature used without package.

CRITICAL FIXES APPLIED (2026-02)
--------------------------------
1. azure.identity in routers/openai.py: Top-level import caused ModuleNotFoundError
   when azure packages removed. FIX: Lazy import inside get_microsoft_entra_id_access_token()

2. 404 on / and /parents: Buildpack apps had no frontend (Python-only).
   FIX: Add heroku/nodejs buildpack BEFORE heroku/python

3. CORS_ALLOW_ORIGIN='*' warning: Set explicit origins for production
   heroku config:set CORS_ALLOW_ORIGIN="https://yourapp.herokuapp.com;http://localhost:8080"

4. Database migration: Release phase in Procfile; migration 38d63c18f30f
   fixes multiple primary keys on user table

5. Slug size: chromadb removed; use VECTOR_DB=pgvector

ENVIRONMENT VARIABLES (Recommended)
-----------------------------------
- ENABLE_IMAGE_GENERATION=false
- AUDIO_STT_ENGINE=""
- AUDIO_TTS_ENGINE=""
- ENABLE_RAG_WEB_SEARCH=false
- ENABLE_RAG_LOCAL_WEB_FETCH=false
- CORS_ALLOW_ORIGIN=<explicit origins, not *>
- VECTOR_DB=pgvector

DOCUMENTATION
-------------
- docs/HEROKU_DEPLOYMENT.md - Full deployment guide and debugging history
- docs/HEROKU_404_FIX.md - Fix 404 on root/frontend routes
- docs/HEROKU_BACKUP_SETUP.md - Postgres backup

DEPLOYMENT COMMANDS
-------------------
# Buildpack app setup
heroku buildpacks:add --index 1 heroku/nodejs -a YOUR_APP
heroku buildpacks:add heroku/python -a YOUR_APP

# Container app setup
heroku stack:set container -a YOUR_APP

# Deploy
git push heroku main

# Verify
heroku logs --tail -a YOUR_APP
heroku buildpacks -a YOUR_APP  # nodejs before python
heroku stack -a YOUR_APP       # container vs heroku-22/24
