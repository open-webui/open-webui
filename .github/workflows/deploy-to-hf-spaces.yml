name: ðŸ¤— CodingSoft HF Spaces Deploy

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

jobs:
  check-secret:
    runs-on: ubuntu-latest
    outputs:
      token-set: ${{ steps.check-key.outputs.defined }}
    steps:
      - id: check-key
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: if [ -n "$HF_TOKEN" ]; then echo "defined=true" >> $GITHUB_OUTPUT; fi

  deploy:
    runs-on: ubuntu-latest
    needs: [check-secret]
    if: needs.check-secret.outputs.token-set == 'true'
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          lfs: true

      - name: Prepare deployment files
        run: |
          rm -rf .git
          # Create temporary README with YAML front matter
          cat > temp_readme.md << 'EOF'
          ---
          title: Open WebUI
          emoji: ðŸ³
          colorFrom: purple
          colorTo: gray
          sdk: docker
          app_port: 8080
          ---
          EOF
          cat README.md >> temp_readme.md
          mv temp_readme.md README.md
          # Remove large files not needed for deployment
          rm -f demo.png banner.png

      - name: Configure Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Deploy to Hugging Face Spaces
        run: |
          git init --initial-branch=main
          git lfs install
          git lfs track "*.ttf"
          git lfs track "*.jpg"
          git add .
          git commit -m "GitHub deploy: ${{ github.sha }}"
          git push --force https://open-webui:${HF_TOKEN}@huggingface.co/spaces/open-webui/open-webui main
