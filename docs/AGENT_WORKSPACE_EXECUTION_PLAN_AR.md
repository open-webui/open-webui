# خطة تنفيذ Agent Workspace (نسخة شبيهة Kimi Claw) — Open WebUI

> الهدف: تحويل بيئة Open WebUI الحالية إلى Agent Workspace دائم بقدرات أدوات/بحث/ملفات/حوكمة، مع تتبع إنجاز واضح ومحدّث داخل هذا الملف.

## طريقة العمل والتحديث

- هذا الملف هو **المرجع الرسمي** للتنفيذ والمتابعة.
- عند إكمال أي مهمة: غيّر حالتها من `[ ]` إلى `[x]`.
- أضف سطرًا في قسم **سجل الإنجاز** يوضح: التاريخ + ما تم + نتيجة التحقق.
- لا نعتبر المهمة مكتملة إلا إذا تم التحقق منها عمليًا (تشغيل/اختبار/مخرجات).

---

## المعمارية المستهدفة (6 طبقات)

1. **واجهة Open WebUI**
   - واجهة واحدة للدردشة + تنفيذ مهام + ملفات.

2. **طبقة النماذج (Model Providers)**
   - دعم z.ai (OpenAI-compatible) و/أو OpenRouter مع سياسات fallback.

3. **طبقة الأدوات (Tools)**
   - بحث ويب مباشر، قراءة روابط/مستندات، تنفيذ كود، وأدوات API خارجية.

4. **طبقة البيانات والذاكرة**
   - ملفات المستخدم + تاريخ المحادثات + (اختياري) قاعدة استرجاع/RAG.

5. **طبقة التنسيق (Pipelines/Workflows)**
   - سلاسل مهام مثل: ابحث → حلل → اكتب تقرير → احفظ.

6. **طبقة الحوكمة والمراقبة**
   - تتبع تكلفة/توكن، حدود ميزانية، سياسات أمان، تنبيهات، Observability.

---

## خارطة التنفيذ (مراحل عملية)

### المرحلة 0 — خط أساس وتشغيل

- [x] توثيق نقاط الوصول الفعالة (`3000` و`3001`) وتحديد بيئة التشغيل المعتمدة.
- [x] توحيد ملف التشغيل الأساسي (compose المعتمد للإنتاج التجريبي).
- [x] التحقق من اتصال النموذج الأساسي (z.ai أو OpenRouter) برد ناجح من الواجهة.

**معيار القبول:** فتح واجهة مستقرة + إرسال Prompt اختبار + استلام رد بدون أخطاء اتصال.

### المرحلة 1 — Agent Workspace دائم

- [x] إعداد Workspace عملي: محادثات منظمة + قوالب مهام متكررة.
- [x] تفعيل فهم السياق عبر الجلسات (جلسة طويلة/ذاكرة المحادثات).
- [x] تعريف 3 Personas تشغيلية (باحث، محلل، منفذ).

**معيار القبول:** نفس المهمة عبر أكثر من جلسة تُظهر استمرارية سياق واضحة.

### المرحلة 2 — Skills / Tools جاهزة

- [x] تفعيل بحث ويب مباشر واختبار جلب مصادر حديثة.
- [x] تفعيل قراءة مستندات/روابط واختبار تلخيص دقيق مع مراجع.
- [x] تفعيل تنفيذ كود مضبوط الصلاحيات واختبار مهمة بسيطة.
- [x] إعداد External Tools / Pipelines لنداء API خارجي واحد على الأقل.

**معيار القبول:** تنفيذ مهمة مركبة تستخدم أداتين على الأقل بنجاح.

### المرحلة 3 — تخزين ملفات مرتبط بالوكيل

- [x] اعتماد أسلوب التخزين: محلي أو سحابي (حسب القرار).
- [x] اختبار رفع ملفات متنوعة (PDF/CSV/TXT) ومعالجتها.
- [x] إضافة سيناريو: رفع ملف → تلخيص → استخراج نقاط → حفظ مخرجات.

**معيار القبول:** إمكانية الرجوع لنفس الملف لاحقًا واستعماله في إجابة جديدة.

### المرحلة 4 — Live Search + مصادر آنية

- [x] إعداد مزود بحث حي (ويب/أسعار/أخبار) مع timeout وحدود واضحة.
- [x] اختبار 5 استعلامات آنية (مال/أخبار/تقنية) مع فحص زمن الاستجابة.
- [x] إضافة fallback عند فشل البحث (رسالة مهذبة + اقتراح بديل).

**معيار القبول:** نتائج حديثة موثقة بمصدر + سلوك واضح عند فشل المصدر.

### المرحلة 5 — Pipelines / Workflows

- [x] بناء Pipeline قياسي: ابحث → حلل → اكتب تقرير → احفظ.
- [x] بناء Pipeline ثانٍ: اقرأ ملف → استخرج KPI → أنشئ ملخص تنفيذي.
- [x] توثيق مدخلات/مخرجات كل Pipeline.

**معيار القبول:** تشغيل Pipeline كامل من الواجهة دون تدخل يدوي بين الخطوات.

### المرحلة 6 — الحوكمة والمراقبة

- [x] تفعيل تتبع التوكن/التكلفة لكل مزود/نموذج.
- [x] تطبيق Budget Guard يومي مع سياسات (`off/warn/clamp/strict`).
- [x] ربط Observability (Langfuse) والتحقق من Trace واحد على الأقل.
- [x] توثيق سياسات الخصوصية والاحتفاظ بالبيانات (Data Handling).

**معيار القبول:** ظهور تقارير تكلفة + تنبيه ميزانية + Trace قابل للمراجعة.

---

## قائمة التسليمات (Deliverables)

- [x] ملف تشغيل معتمد وواضح (Compose + Env).
- [x] دليل استخدام مختصر للمستخدم النهائي (تشغيل/اختيار نموذج/أدوات).
- [x] تقرير صحة شامل: الاتصال + الأدوات + البحث + الذاكرة + الحوكمة.
- [x] تقرير Go/No-Go نهائي قبل الاعتماد.

---

## سجل الإنجاز (يُحدّث باستمرار)

> تنسيق السطر: `YYYY-MM-DD | البند | النتيجة | دليل التحقق`

- 2026-02-15 | إنشاء خطة التنفيذ والمتابعة | تم | إنشاء هذا الملف واعتماده كمرجع متابعة رسمي.
- 2026-02-15 | توثيق نقاط الوصول الفعالة | تم | HTTP 200 على `http://localhost:3000` و`http://localhost:3001`.
- 2026-02-15 | اعتماد بيئة التشغيل الأساسية | تم | اعتماد `docker-compose.yaml` (حاوية `open-webui` على `3001`) كبيئة رئيسية.
- 2026-02-15 | ضبط بيئة ثانوية للاختبار السريع | تم | الإبقاء على `docker-compose.openwebui.yml` (حاوية `openwebui` على `3000`) كبيئة ثانوية.
- 2026-02-15 | تحقق اتصال مزوّد النماذج (البيئة الأساسية) | تم | `SIDECAR_HEALTH_HTTP:200` على `http://localhost:4000/health`.
- 2026-02-15 | تحقق اتصال مزوّد النماذج (البيئة الثانوية) | تم | `ZAI_MODELS_HTTP:200` من endpoint النماذج.
- 2026-02-15 | تجهيز قوالب Workspace عملية | تم | إنشاء `docs/AGENT_WORKSPACE_TEMPLATES_AR.md` (تنظيم جلسات + قوالب مهام متكررة).
- 2026-02-15 | تجهيز Personas تشغيلية | تم | إضافة 3 Personas جاهزة (Researcher / Analyst / Executor) للاستخدام المباشر.
- 2026-02-15 | إصلاح البحث الحي (SearXNG JSON) | تم | تحديث `docker-compose.day1.yaml` لتمكين `json` داخل `search.formats` عند الإقلاع.
- 2026-02-15 | اختبار Live Search (5 استعلامات) | تم | جميع الاستعلامات رجعت `HTTP 200` بنتائج فعلية (30-35 نتيجة) بزمن ~950ms إلى ~2181ms.
- 2026-02-15 | تنفيذ fallback مهذب لفشل البحث الحي | تم | تعديل `backend/open_webui/routers/retrieval.py` لإرجاع استجابة آمنة عند فشل المزود/عدم النتائج/فشل loader عبر `WEB_SEARCH_ENABLE_FALLBACK`.
- 2026-02-16 | اختبار وحدة لاستجابة fallback | تم | تشغيل `pytest` عبر `.venv311` على الملف `backend/open_webui/test/test_web_search_governance.py` بنتيجة `4 passed`.
- 2026-02-16 | إغلاق التحقق الشامل للـ Agent Workspace | تم | تشغيل `scripts/validate_agent_workspace_full.ps1` بنتيجة `PASS=7 / FAIL=0` وتوليد `VALIDATION_REPORT_AGENT_WORKSPACE_AR.md`.
- 2026-02-16 | توثيق Pipelines التشغيلية | تم | إضافة `docs/AGENT_WORKSPACE_PIPELINES_AR.md` لتعريف خطّي التشغيل (Inputs/Steps/Outputs).
- 2026-02-16 | توثيق دليل المستخدم النهائي | تم | إضافة `docs/AGENT_WORKSPACE_USER_GUIDE_AR.md` (تشغيل + نماذج + أدوات + حوكمة).
- 2026-02-16 | توثيق سياسة البيانات والخصوصية | تم | إضافة `docs/AGENT_WORKSPACE_DATA_POLICY_AR.md`.
- 2026-02-16 | تقرير قرار الاعتماد النهائي | تم | إضافة `docs/AGENT_WORKSPACE_GO_NO_GO_AR.md` بحالة **GO**.

---

## الحالة الحالية السريعة

- الحالة العامة: **مكتمل**
- نسبة الإنجاز التقديرية: **100%**
- المرحلة النشطة: **تم إغلاق جميع المراحل (0 → 6)**
- العوائق الحالية: لا يوجد عائق مفتوح ضمن نطاق الخطة الحالية.
