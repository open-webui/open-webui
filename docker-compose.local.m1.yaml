version: '3.8'

# M1 Mac optimized version - uses native ARM64 builds
services:
  redis:
    image: redis:7-alpine
    container_name: open-webui-redis
    # M1: Use native ARM64, no platform restriction needed
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  open-webui:
    build:
      context: .
      dockerfile: Dockerfile
      # M1: Build natively for ARM64 (faster, no emulation)
      # If you need AMD64, use: platform: linux/amd64
    image: test_a3
    container_name: open-webui-app
    volumes:
      - open-webui-data:/app/backend/data
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      # Redis Configuration (REQUIRED for job queue)
      - REDIS_URL=redis://redis:6379/0
      - REDIS_MAX_CONNECTIONS=100
      
      # Job Queue Configuration (REQUIRED)
      - ENABLE_JOB_QUEUE=True
      - JOB_TIMEOUT=3600
      - JOB_MAX_RETRIES=3
      - JOB_RETRY_DELAY=60
      - JOB_RESULT_TTL=3600
      - JOB_FAILURE_TTL=86400
      
      # Application Configuration
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:-}
      - WEBUI_JWT_SECRET_KEY=${WEBUI_JWT_SECRET_KEY:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-}
      
      # Database Configuration (defaults to SQLite - don't set if using default)
      # - DATABASE_URL=${DATABASE_URL:-}  # Uncomment and set if using PostgreSQL
      
      # Vector DB Configuration
      # Use 'chroma' for SQLite (local), 'pgvector' for PostgreSQL (production)
      - VECTOR_DB=${VECTOR_DB:-chroma}
      
      # Embedding Configuration
      - RAG_EMBEDDING_ENGINE=${RAG_EMBEDDING_ENGINE:-portkey}
      - RAG_EMBEDDING_MODEL=${RAG_EMBEDDING_MODEL:-@openai-embedding/text-embedding-3-small}
      - RAG_OPENAI_API_BASE_URL=${RAG_OPENAI_API_BASE_URL:-}
      - RAG_OPENAI_API_KEY=${RAG_OPENAI_API_KEY:-}
      
      # Logging Configuration
      - GLOBAL_LOG_LEVEL=${GLOBAL_LOG_LEVEL:-INFO}
      - WORKER_LOG_LEVEL=${WORKER_LOG_LEVEL:-INFO}
      
      # Docker flag
      - DOCKER=true
    extra_hosts:
      - host.docker.internal:host-gateway
    restart: unless-stopped
    # Don't start worker in main container - use separate worker service
    command: bash -c "exec uvicorn open_webui.main:app --host 0.0.0.0 --port 8080 --forwarded-allow-ips '*'"

  open-webui-worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: test_a3
    container_name: open-webui-worker
    volumes:
      - open-webui-data:/app/backend/data
    depends_on:
      redis:
        condition: service_healthy
      open-webui:
        condition: service_started
    environment:
      # Redis Configuration (REQUIRED for job queue)
      - REDIS_URL=redis://redis:6379/0
      - REDIS_MAX_CONNECTIONS=100
      
      # Job Queue Configuration (REQUIRED)
      - ENABLE_JOB_QUEUE=True
      - JOB_TIMEOUT=3600
      - JOB_MAX_RETRIES=3
      - JOB_RETRY_DELAY=60
      - JOB_RESULT_TTL=3600
      - JOB_FAILURE_TTL=86400
      
      # Application Configuration
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:-}
      - WEBUI_JWT_SECRET_KEY=${WEBUI_JWT_SECRET_KEY:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-}
      
      # Database Configuration (defaults to SQLite - don't set if using default)
      # - DATABASE_URL=${DATABASE_URL:-}  # Uncomment and set if using PostgreSQL
      
      # Vector DB Configuration
      # Use 'chroma' for SQLite (local), 'pgvector' for PostgreSQL (production)
      - VECTOR_DB=${VECTOR_DB:-chroma}
      
      # Embedding Configuration
      - RAG_EMBEDDING_ENGINE=${RAG_EMBEDDING_ENGINE:-portkey}
      - RAG_EMBEDDING_MODEL=${RAG_EMBEDDING_MODEL:-@openai-embedding/text-embedding-3-small}
      - RAG_OPENAI_API_BASE_URL=${RAG_OPENAI_API_BASE_URL:-}
      - RAG_OPENAI_API_KEY=${RAG_OPENAI_API_KEY:-}
      
      # Logging Configuration
      - GLOBAL_LOG_LEVEL=${GLOBAL_LOG_LEVEL:-INFO}
      - WORKER_LOG_LEVEL=${WORKER_LOG_LEVEL:-INFO}
      
      # Docker flag
      - DOCKER=true
    restart: unless-stopped
    command: python -m open_webui.workers.start_worker

volumes:
  redis-data:
  open-webui-data:
