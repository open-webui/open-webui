{"version":3,"file":"17.D2n-7dXm.js","sources":["../../../../../../src/lib/components/playground/Completions.svelte"],"sourcesContent":["<script lang=\"ts\">\n\timport { toast } from 'svelte-sonner';\n\n\timport { goto } from '$app/navigation';\n\timport { onMount, tick, getContext } from 'svelte';\n\n\timport { WEBUI_BASE_URL } from '$lib/constants';\n\timport { WEBUI_NAME, config, user, models, settings, showSidebar } from '$lib/stores';\n\timport { generateOpenAIChatCompletion } from '$lib/apis/openai';\n\n\timport { splitStream } from '$lib/utils';\n\timport Selector from '$lib/components/chat/ModelSelector/Selector.svelte';\n\timport MenuLines from '../icons/MenuLines.svelte';\n\n\tconst i18n = getContext('i18n');\n\n\tlet loaded = false;\n\tlet text = '';\n\n\tlet selectedModelId = '';\n\n\tlet loading = false;\n\tlet stopResponseFlag = false;\n\n\tlet textCompletionAreaElement: HTMLTextAreaElement;\n\n\tconst scrollToBottom = () => {\n\t\tconst element = textCompletionAreaElement;\n\n\t\tif (element) {\n\t\t\telement.scrollTop = element?.scrollHeight;\n\t\t}\n\t};\n\n\tconst stopResponse = () => {\n\t\tstopResponseFlag = true;\n\t\tconsole.log('stopResponse');\n\t};\n\n\tconst textCompletionHandler = async () => {\n\t\tconst model = $models.find((model) => model.id === selectedModelId);\n\n\t\tconst [res, controller] = await generateOpenAIChatCompletion(\n\t\t\tlocalStorage.token,\n\t\t\t{\n\t\t\t\tmodel: model.id,\n\t\t\t\tstream: true,\n\t\t\t\tmessages: [\n\t\t\t\t\t{\n\t\t\t\t\t\trole: 'assistant',\n\t\t\t\t\t\tcontent: text\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t},\n\t\t\t`${WEBUI_BASE_URL}/api`\n\t\t);\n\n\t\tif (res && res.ok) {\n\t\t\tconst reader = res.body\n\t\t\t\t.pipeThrough(new TextDecoderStream())\n\t\t\t\t.pipeThrough(splitStream('\\n'))\n\t\t\t\t.getReader();\n\n\t\t\twhile (true) {\n\t\t\t\tconst { value, done } = await reader.read();\n\t\t\t\tif (done || stopResponseFlag) {\n\t\t\t\t\tif (stopResponseFlag) {\n\t\t\t\t\t\tcontroller.abort('User: Stop Response');\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\tlet lines = value.split('\\n');\n\n\t\t\t\t\tfor (const line of lines) {\n\t\t\t\t\t\tif (line !== '') {\n\t\t\t\t\t\t\tif (line.includes('[DONE]')) {\n\t\t\t\t\t\t\t\tconsole.log('done');\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet data = JSON.parse(line.replace(/^data: /, ''));\n\t\t\t\t\t\t\t\tconsole.log(data);\n\n\t\t\t\t\t\t\t\ttext += data.choices[0].delta.content ?? '';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.log(error);\n\t\t\t\t}\n\n\t\t\t\tscrollToBottom();\n\t\t\t}\n\t\t}\n\t};\n\n\tconst submitHandler = async () => {\n\t\tif (selectedModelId) {\n\t\t\tloading = true;\n\t\t\tawait textCompletionHandler();\n\n\t\t\tloading = false;\n\t\t\tstopResponseFlag = false;\n\t\t}\n\t};\n\n\tonMount(async () => {\n\t\tif ($user?.role !== 'admin') {\n\t\t\tawait goto('/');\n\t\t}\n\n\t\tif ($settings?.models) {\n\t\t\tselectedModelId = $settings?.models[0];\n\t\t} else if ($config?.default_models) {\n\t\t\tselectedModelId = $config?.default_models.split(',')[0];\n\t\t} else {\n\t\t\tselectedModelId = '';\n\t\t}\n\t\tloaded = true;\n\t});\n</script>\n\n<div class=\" flex flex-col justify-between w-full overflow-y-auto h-full\">\n\t<div class=\"mx-auto w-full md:px-0 h-full\">\n\t\t<div class=\" flex flex-col h-full px-4\">\n\t\t\t<div class=\"flex flex-col justify-between mb-1 gap-1\">\n\t\t\t\t<div class=\"flex flex-col gap-1 w-full\">\n\t\t\t\t\t<div class=\"flex w-full\">\n\t\t\t\t\t\t<div class=\"overflow-hidden w-full\">\n\t\t\t\t\t\t\t<div class=\"max-w-full\">\n\t\t\t\t\t\t\t\t<Selector\n\t\t\t\t\t\t\t\t\tplaceholder={$i18n.t('Select a model')}\n\t\t\t\t\t\t\t\t\titems={$models.map((model) => ({\n\t\t\t\t\t\t\t\t\t\tvalue: model.id,\n\t\t\t\t\t\t\t\t\t\tlabel: model.name,\n\t\t\t\t\t\t\t\t\t\tmodel: model\n\t\t\t\t\t\t\t\t\t}))}\n\t\t\t\t\t\t\t\t\tbind:value={selectedModelId}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div\n\t\t\t\tclass=\" pt-0.5 pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0\"\n\t\t\t\tid=\"messages-container\"\n\t\t\t>\n\t\t\t\t<div class=\" h-full w-full flex flex-col\">\n\t\t\t\t\t<div class=\"flex-1\">\n\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\tid=\"text-completion-textarea\"\n\t\t\t\t\t\t\tbind:this={textCompletionAreaElement}\n\t\t\t\t\t\t\tclass=\"w-full h-full p-3 bg-transparent border border-gray-50 dark:border-gray-850 outline-none resize-none rounded-lg text-sm\"\n\t\t\t\t\t\t\tbind:value={text}\n\t\t\t\t\t\t\tplaceholder={$i18n.t(\"You're a helpful assistant.\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class=\"pb-3 flex justify-end\">\n\t\t\t\t{#if !loading}\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"px-3.5 py-1.5 text-sm font-medium bg-black hover:bg-gray-900 text-white dark:bg-white dark:text-black dark:hover:bg-gray-100 transition rounded-full\"\n\t\t\t\t\t\ton:click={() => {\n\t\t\t\t\t\t\tsubmitHandler();\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{$i18n.t('Run')}\n\t\t\t\t\t</button>\n\t\t\t\t{:else}\n\t\t\t\t\t<button\n\t\t\t\t\t\tclass=\"px-3 py-1.5 text-sm font-medium bg-gray-300 text-black transition rounded-full\"\n\t\t\t\t\t\ton:click={() => {\n\t\t\t\t\t\t\tstopResponse();\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{$i18n.t('Cancel')}\n\t\t\t\t\t</button>\n\t\t\t\t{/if}\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n\n<style>\n\t.scrollbar-hidden::-webkit-scrollbar {\n\t\tdisplay: none; /* for Chrome, Safari and Opera */\n\t}\n\n\t.scrollbar-hidden {\n\t\t-ms-overflow-style: none; /* IE and Edge */\n\t\tscrollbar-width: none; /* Firefox */\n\t}\n</style>\n"],"names":["ctx","insert_hydration","target","button","anchor","set_data","t","t_value","func","create_if_block","div11","append_hydration","div10","div9","div4","div3","div2","div1","div0","div7","div6","div5","textarea","div8","dirty","selector_changes","model","i18n","getContext","text","selectedModelId","loading","stopResponseFlag","textCompletionAreaElement","scrollToBottom","element","stopResponse","textCompletionHandler","$models","res","controller","generateOpenAIChatCompletion","WEBUI_BASE_URL","reader","splitStream","value","done","lines","line","data","$$invalidate","error","submitHandler","onMount","$user","goto","$settings","$config","$$value"],"mappings":"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"}